<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="root.SqlMapper">
    <select id="selectWord" resultType="map">
        select * from llm_word w where w.type != 'opener'
    </select>
    <select id="selectSymbolWord" resultType="map">
        select * from llm_word w where w.type = '기호'
    </select>
    <select id="selectContext" resultType="map">select * from plm_context c</select>
    <select id="selectCompound" resultType="map">select * from llm_word_compound c</select>
    <select id="selectGenerationTarget" resultType="root.UltronContext">
        select sq.leftword, sq.rightword, sq.context, lw.word lw, rw.word rw, sq.cnt, sq.space, max(sq.pri) pri, count(*) rcnt
        from llm_word lw, llm_word rw, (
            select c.leftword, c.rightword, c.cnt, c.space, uc.i, os.n = uc.sentence pri, uc.context,
            row_number() over (partition by ifnull(os.n, container.sentence), uc.context, pri, container.i order by uc.i) rn
            from plm_ultron_context uc, plm_context c, (
                select uc.sentence, p.i from plm_ultron_context uc, plm_context c, (
                <foreach collection="list" item="item" separator=" union all " index="i">select #{item.n} n, #{i} i, #{item.rightword} r</foreach>
                ) p
                where uc.context = c.n
                and c.leftword = p.n
                and c.rightword = p.r
                group by uc.sentence, p.i
            ) container left join plm_ultron_sentence os on container.sentence = os.target
            where ifnull(os.n, container.sentence) = uc.sentence
            and uc.context = c.n
        ) sq
        where sq.leftword = lw.n and sq.rightword = rw.n
        group by sq.leftword, sq.rightword, sq.rn
        order by pri desc, rcnt desc, sq.i limit #{limit}
    </select>
    <select id="selectConsumer" resultType="root.mind.ConsumeContext">
        -- 이걸 위 쿼리에서 레프트 조인을 할 까 메모리에 올려놓고 쓸 까 정말 많은 고민을 했다
        -- 이 시점에 난 장기적으로 뭐가 나을지 알 수가 없고, 레프트 조인을 먼저 하면 왠지 나중에 떼기가 힘들 것 같아 우선 메모리에 올려놓기로 한다
        -- 또한 사람이라면 항상 갖고 있는 지식일테니 사람에 가까운 구현 방식인 점도 한 몫 한다
        select DISTINCT mer.context mer, mable.context mable from (
            select t.n, max(t.ci) ci, t.context from plm_token t, llm_word w
            where t.rightword = w.n
            and w.type = '무엇'
            group by t.n, t.context
        ) mer, (
            select t.n, min(t.ci) ci, t.context from plm_token t, llm_word w
            where t.leftword = w.n
            and w.type in ('무엇', '대명사', '0')
            group by t.n, t.context
        ) mable
        where mer.n = mable.n
        and mer.ci >= mable.ci
        -- order by mer
    </select>
</mapper>